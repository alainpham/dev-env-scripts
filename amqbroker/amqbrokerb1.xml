<?xml version='1.0' encoding="UTF-8"?>

<configuration xmlns="urn:activemq" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:activemq schema/artemis-server.xsd urn:activemq:core schema/artemis-configuration.xsd">

   <core xmlns="urn:activemq:core" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="urn:activemq:core ">

      <name>amqbrokerb1</name>
      <persistence-enabled>true</persistence-enabled>
      <journal-type>NIO</journal-type>
      <paging-directory>/opt/amq/data/paging</paging-directory>
      <bindings-directory>/opt/amq/data/bindings</bindings-directory>
      <journal-directory>/opt/amq/data/journal</journal-directory>
      <large-messages-directory>/opt/amq/data/large-messages</large-messages-directory>
      <journal-datasync>true</journal-datasync>
      <journal-min-files>2</journal-min-files>
      <journal-pool-files>10</journal-pool-files>
      <journal-device-block-size>4096</journal-device-block-size>
      <journal-file-size>10M</journal-file-size>
      <journal-buffer-timeout>1052000</journal-buffer-timeout>
      <journal-max-io>1</journal-max-io>
      <disk-scan-period>5000</disk-scan-period>
      <max-disk-usage>90</max-disk-usage>
      <critical-analyzer>true</critical-analyzer>
      <critical-analyzer-timeout>120000</critical-analyzer-timeout>
      <critical-analyzer-check-period>60000</critical-analyzer-check-period>
      <critical-analyzer-policy>HALT</critical-analyzer-policy>
      <page-sync-timeout>1052000</page-sync-timeout>

      <connectors>
         <connector name="artemis">tcp://amqbrokerb1:61616</connector>
         <connector name="artemis-ssl">tcp://amqbrokerb1:61617?sslEnabled=true;keyStorePath=/etc/amq-secret-volume/amqbrokerb1-keystore.p12;keyStorePassword=password;trustStorePath=/etc/amq-secret-volume/truststore.p12;trustStorePassword=password;sslProvider=JDK</connector>
         <connector name="artemis-mirror">(tcp://amqbrokera1:61617,tcp://amqbrokera0:61617,tcp://amqbrokera1:61617)?sslEnabled=true;keyStorePath=/etc/amq-secret-volume/amqbrokerb1-keystore.p12;keyStorePassword=password;trustStorePath=/etc/amq-secret-volume/truststore.p12;trustStorePassword=password;sslProvider=JDK</connector>
         
<connector name="a0">tcp://amqbrokera0:61617?sslEnabled=true;keyStorePath=/etc/amq-secret-volume/amqbrokerb1-keystore.p12;keyStorePassword=password;trustStorePath=/etc/amq-secret-volume/truststore.p12;trustStorePassword=password;sslProvider=JDK</connector>
<connector name="a1">tcp://amqbrokera1:61617?sslEnabled=true;keyStorePath=/etc/amq-secret-volume/amqbrokerb1-keystore.p12;keyStorePassword=password;trustStorePath=/etc/amq-secret-volume/truststore.p12;trustStorePassword=password;sslProvider=JDK</connector>
      </connectors>

      <cluster-user>cluster-user</cluster-user>

      <cluster-password>password</cluster-password>

      <broadcast-groups>
         <broadcast-group name="amqbrokerb-broadcast-group">
            <local-bind-address>172.18.0.111</local-bind-address>
            <local-bind-port>5432</local-bind-port>
            <group-address>231.7.7.7</group-address>
            <group-port>9877</group-port>
            <broadcast-period>2000</broadcast-period>
            <connector-ref>artemis-ssl</connector-ref>
         </broadcast-group>
      </broadcast-groups>

      <discovery-groups>
         <discovery-group name="amqbrokerb-discovery-group">
            <local-bind-address>172.18.0.111</local-bind-address>
            <group-address>231.7.7.7</group-address>
            <group-port>9877</group-port>
            <refresh-timeout>10000</refresh-timeout>
         </discovery-group>
      </discovery-groups>

      <cluster-connections>
         <cluster-connection name="amqbrokerb-cluster">
            <!-- <address>!#::federated.#</address> -->
            <connector-ref>artemis-ssl</connector-ref>
            <retry-interval>1000</retry-interval>
            <retry-interval-multiplier>2</retry-interval-multiplier>
            <max-retry-interval>10000</max-retry-interval>
            <initial-connect-attempts>-1</initial-connect-attempts>
            <reconnect-attempts>-1</reconnect-attempts>
            <use-duplicate-detection>true</use-duplicate-detection>
            <message-load-balancing>ON_DEMAND</message-load-balancing>
            <max-hops>1</max-hops>
            <discovery-group-ref discovery-group-name="amqbrokerb-discovery-group" />
         </cluster-connection>
      </cluster-connections>

      <acceptors>

         <acceptor name="artemis">tcp://0.0.0.0:61616?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;amqpMinLargeMessageSize=102400;protocols=CORE,AMQP,STOMP,HORNETQ,MQTT,OPENWIRE;useEpoll=true;amqpCredits=1000;amqpLowCredits=300;amqpDuplicateDetection=true</acceptor>
         <acceptor name="amqp">tcp://0.0.0.0:5672?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;protocols=AMQP;useEpoll=true;amqpCredits=1000;amqpLowCredits=300;amqpMinLargeMessageSize=102400;amqpDuplicateDetection=true</acceptor>
         <acceptor name="stomp">tcp://0.0.0.0:61613?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;protocols=STOMP;useEpoll=true</acceptor>
         <acceptor name="hornetq">tcp://0.0.0.0:5445?anycastPrefix=jms.queue.;multicastPrefix=jms.topic.;protocols=HORNETQ,STOMP;useEpoll=true</acceptor>
         <acceptor name="mqtt">tcp://0.0.0.0:1883?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;protocols=MQTT;useEpoll=true</acceptor>

         <acceptor name="artemis-ssl">tcp://0.0.0.0:61617?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;protocols=CORE,AMQP,STOMP,HORNETQ,MQTT,OPENWIRE;useEpoll=true;amqpCredits=1000;amqpLowCredits=300;connectionsAllowed=1000;sslEnabled=true;keyStorePath=/etc/amq-secret-volume/amqbrokerb1-keystore.p12;keyStorePassword=password;trustStorePath=/etc/amq-secret-volume/truststore.p12;trustStorePassword=password;sslProvider=JDK;needClientAuth=true</acceptor>
         <acceptor name="amqp-ssl">tcp://0.0.0.0:5671?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;protocols=AMQP;useEpoll=true;amqpCredits=1000;amqpMinCredits=300;connectionsAllowed=1000;sslEnabled=true;keyStorePath=/etc/amq-secret-volume/amqbrokerb1-keystore.p12;keyStorePassword=password;trustStorePath=/etc/amq-secret-volume/truststore.p12;trustStorePassword=password;sslProvider=JDK;needClientAuth=true</acceptor>
         <acceptor name="stomp-ssl">tcp://0.0.0.0:61612?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;protocols=STOMP;useEpoll=true;connectionsAllowed=1000;sslEnabled=true;keyStorePath=/etc/amq-secret-volume/amqbrokerb1-keystore.p12;keyStorePassword=password;trustStorePath=/etc/amq-secret-volume/truststore.p12;trustStorePassword=password;sslProvider=JDK;needClientAuth=true</acceptor>
         <acceptor name="mqtt-ssl">tcp://0.0.0.0:8883?tcpSendBufferSize=1048576;tcpReceiveBufferSize=1048576;protocols=MQTT;useEpoll=true;connectionsAllowed=1000;sslEnabled=true;keyStorePath=/etc/amq-secret-volume/amqbrokerb1-keystore.p12;keyStorePassword=password;trustStorePath=/etc/amq-secret-volume/truststore.p12;trustStorePassword=password;sslProvider=JDK;needClientAuth=true</acceptor>

      </acceptors>

      <!-- <queue-policy  name="upstream-of-amqbrokerb1-queue-policy" priority-adjustment="-1" include-federated="false"> -->
      <!-- <address-policy name="upstream-of-amqbrokerb1-addr-policy" auto-delete="false" max-hops="1" > -->
      <federations>
         <federation name="amqbrokerb-federation" user="amqbrokerb1" password="password">
            <upstream name="upstream-of-amqbrokerb" >
               <ha>true</ha>
               <!--<circuit-breaker-timeout>5000</circuit-breaker-timeout>
               <connection-ttl>30000</connection-ttl>
               <call-timeout>30000</call-timeout> -->
               <retry-interval>2000</retry-interval>
               <retry-interval-multiplier>2</retry-interval-multiplier>
               <max-retry-interval>10000</max-retry-interval>
               <initial-connect-attempts>-1</initial-connect-attempts>
               <reconnect-attempts>-1</reconnect-attempts>
               <!-- <check-period>10000</check-period>
               <call-failover-timeout>3000</call-failover-timeout> -->
               <static-connectors >
               <!-- <connector-ref>artemis-mirror</connector-ref> -->
                  
<connector-ref>a0</connector-ref>
<connector-ref>a1</connector-ref>
               </static-connectors>
               <policy ref="upstream-of-amqbrokerb-addr-policy" />
               <policy ref="upstream-of-amqbrokerb-queue-policy" />
            </upstream>
            <queue-policy  name="upstream-of-amqbrokerb-queue-policy"  priority-adjustment="0" >
               <include queue-match="app.queue.federation.#" address-match="app.queue.federation.#" />
            </queue-policy>
            <address-policy name="upstream-of-amqbrokerb-addr-policy"  max-hops="1">
               <include address-match="app.addr.federation.#" />
            </address-policy>
         </federation>
      </federations>
      <security-settings>
         <security-setting match="#">
            <permission type="createNonDurableQueue" roles="admin"/>
            <permission type="deleteNonDurableQueue" roles="admin"/>
            <permission type="createDurableQueue" roles="admin"/>
            <permission type="deleteDurableQueue" roles="admin"/>
            <permission type="createAddress" roles="admin"/>
            <permission type="deleteAddress" roles="admin"/>
            <permission type="consume" roles="admin"/>
            <permission type="browse" roles="admin"/>
            <permission type="send" roles="admin"/>
            <permission type="manage" roles="admin"/>
         </security-setting>
      </security-settings>

      <address-settings>
         <address-setting match="activemq.management#">
            <dead-letter-address>DLQ</dead-letter-address>
            <expiry-address>ExpiryQueue</expiry-address>
            <redelivery-delay>0</redelivery-delay>
            <max-size-bytes>-1</max-size-bytes>
            <message-counter-history-day-limit>10</message-counter-history-day-limit>
            <address-full-policy>PAGE</address-full-policy>
            <auto-create-queues>true</auto-create-queues>
            <auto-create-addresses>true</auto-create-addresses>
            <auto-create-jms-queues>true</auto-create-jms-queues>
            <auto-create-jms-topics>true</auto-create-jms-topics>
         </address-setting>
         <address-setting match="#">
            <dead-letter-address>DLQ</dead-letter-address>
            <expiry-address>ExpiryQueue</expiry-address>
            <redelivery-delay>0</redelivery-delay>
            <max-size-bytes>-1</max-size-bytes>
            <message-counter-history-day-limit>10</message-counter-history-day-limit>
            <address-full-policy>PAGE</address-full-policy>
            <auto-create-queues>true</auto-create-queues>
            <auto-create-addresses>true</auto-create-addresses>
            <auto-create-jms-queues>true</auto-create-jms-queues>
            <auto-create-jms-topics>true</auto-create-jms-topics>
         </address-setting>
      </address-settings>

      <addresses>
         <address name="DLQ">
            <anycast>
               <queue name="DLQ" />
            </anycast>
         </address>
         <address name="ExpiryQueue">
            <anycast>
               <queue name="ExpiryQueue" />
            </anycast>
         </address>
         <address name="app.queue">
            <anycast>
               <queue name="app.queue" />
            </anycast>
         </address>
         <address name="app.queue.federation.test">
            <anycast>
               <queue name="app.queue.federation.test" />
            </anycast>
         </address>
         <address name="app.addr">
            <multicast/>
         </address>
         <address name="app.addr.federation.test">
            <multicast/>
         </address>

      </addresses>

      <!-- <metrics-plugin class-name="org.apache.activemq.artemis.core.server.metrics.plugins.ArtemisPrometheusMetricsPlugin"/> -->
      <metrics> <plugin class-name="org.apache.activemq.artemis.core.server.metrics.plugins.ArtemisPrometheusMetricsPlugin"/> </metrics>
   </core>
</configuration>